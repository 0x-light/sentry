<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>sentry</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #fff; --bg-alt: #f8f8f8; --text: #555; --text-strong: #222; --text-muted: #999;
  --border: #eee; --border-light: #f3f3f3; --accent: #1a7a1a; --danger: #cc3333;
  --link: #2255bb; --chip-bg: transparent; --chip-border: #ddd;
}
[data-theme="dark"] {
  --bg: #0d0d0d; --bg-alt: #161616; --text: #999; --text-strong: #e0e0e0; --text-muted: #666;
  --border: #222; --border-light: #1a1a1a; --accent: #4ade80; --danger: #f87171;
  --link: #60a5fa; --chip-bg: #1a1a1a; --chip-border: #333;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 13px; -webkit-font-smoothing: antialiased;
}
::selection { background: #e8f4e8; color: #1a7a1a; }
[data-theme="dark"] ::selection { background: #1a3a1a; color: #4ade80; }
input::placeholder { color: var(--text-muted); }
button { font-family: inherit; cursor: pointer; }

.topbar {
  padding: 20px 32px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.logo { display: flex; align-items: center; gap: 8px; }
.dot { font-size: 8px; color: var(--text-strong); line-height: 1; }
.dot.loading { animation: pulse 0.6s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
.logo-text { font-size: 13px; font-weight: 500; color: var(--text-strong); letter-spacing: .06em; }
.topbar-right { display: flex; align-items: center; gap: 16px; }
.prog { font-size: 12px; color: var(--text-muted); }
.top-btn { background: none; border: none; font-size: 11px; color: var(--text-muted); padding: 2px 0; }
.top-btn:hover { color: var(--text); }
.top-btn.set { color: var(--accent); }

/* modal */
.modal-bg {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,.3); z-index: 100;
  align-items: center; justify-content: center;
}
.modal-bg.open { display: flex; }
.modal {
  background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
  padding: 28px 32px; width: 480px; max-width: 90vw; max-height: 90vh; overflow-y: auto;
}
.modal h3 { font-size: 13px; font-weight: 500; color: var(--text-strong); margin-bottom: 6px; }
.modal p { font-size: 11px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; }
.modal p a { color: var(--link); text-decoration: none; }
.modal p a:hover { text-decoration: underline; }
.modal label { display: block; font-size: 11px; color: var(--text); margin-bottom: 4px; margin-top: 14px; }
.modal label:first-of-type { margin-top: 0; }
.modal input, .modal select, .modal textarea {
  width: 100%; border: 1px solid var(--chip-border); border-radius: 2px; padding: 8px 10px;
  font-family: inherit; font-size: 12px; color: var(--text-strong); outline: none;
  background: var(--bg); resize: vertical;
}
.modal input:focus, .modal textarea:focus { border-color: var(--text-muted); }
.modal-actions { display: flex; gap: 8px; margin-top: 18px; justify-content: flex-end; flex-wrap: wrap; }
.modal-actions button {
  background: none; border: 1px solid var(--chip-border); border-radius: 2px;
  font-size: 11px; padding: 5px 14px; color: var(--text);
}
.modal-actions button:hover { border-color: var(--text-muted); color: var(--text-strong); }
.modal-actions button.danger { color: var(--danger); }
.modal-actions button.danger:hover { border-color: var(--danger); }
.preset-list { margin-top: 16px; border-top: 1px solid var(--border); padding-top: 12px; }
.preset-list-item {
  display: flex; align-items: center; justify-content: space-between; padding: 6px 0;
  border-bottom: 1px solid var(--border-light); font-size: 12px;
}
.preset-list-item span { color: var(--text-strong); }
.preset-list-item small { color: var(--text-muted); margin-left: 8px; }
.preset-list-item button { background: none; border: none; color: var(--danger); font-size: 11px; padding: 2px 6px; }

.controls { padding: 20px 32px 16px; border-bottom: 1px solid var(--border); }
.input-row { display: flex; gap: 6px; align-items: center; margin-bottom: 12px; }
.input-row .at { color: var(--text-muted); font-size: 13px; }
.input-row input {
  flex: 1; background: transparent; border: none; outline: none;
  color: var(--text-strong); font-size: 13px; font-family: inherit; padding: 6px 0;
}
.add-btn { background: none; border: none; color: var(--text-muted); font-size: 12px; padding: 4px 8px; display: none; }
.add-btn.vis { display: inline; }

.presets-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 14px; }
.presets-row .label { font-size: 11px; color: var(--text-muted); margin-right: 2px; }
.preset-btn {
  background: none; border: 1px solid var(--chip-border); border-radius: 2px;
  color: var(--text-muted); font-size: 11px; padding: 3px 10px;
}
.preset-btn:hover { color: var(--text-strong); border-color: var(--text-muted); }
.preset-btn.active { color: var(--accent); border-color: var(--accent); }
.preset-manage { background: none; border: none; color: var(--text-muted); font-size: 11px; padding: 3px 6px; }
.preset-manage:hover { color: var(--text-strong); }

.suggested { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: 14px; }
.sug { background: none; border: none; color: var(--text-muted); font-size: 12px; margin-right: 10px; }
.sug:hover { color: var(--text-strong); }
.sug.used { opacity: .35; cursor: default; }

.ranges { display: flex; gap: 16px; align-items: center; }
.ranges.mb { margin-bottom: 14px; }
.ranges .label { font-size: 11px; color: var(--text-muted); margin-right: 2px; }
.rng {
  background: none; border: none; border-bottom: 1.5px solid transparent;
  color: var(--text-muted); font-size: 12px; padding: 2px 0;
}
.rng:hover { color: var(--text-strong); }
.rng.on { color: var(--text-strong); border-bottom-color: var(--text-strong); }

.chips { display: none; align-items: center; gap: 8px; flex-wrap: wrap; }
.chips.vis { display: flex; }
.chip {
  font-size: 12px; color: var(--text-strong); background: var(--chip-bg); border: 1px solid var(--chip-border); border-radius: 2px;
  padding: 3px 8px; display: inline-flex; align-items: center; gap: 6px;
}
.chip:hover { border-color: var(--text-muted); }
.chip .x { cursor: pointer; color: var(--text-muted); font-size: 10px; }
.scan-btn {
  margin-left: auto; background: none; border: 1px solid var(--chip-border); border-radius: 2px;
  color: var(--text-muted); font-size: 12px; padding: 5px 16px; letter-spacing: .04em;
  font-family: monospace;
}
.scan-btn:hover:not(:disabled) { color: var(--accent); border-color: var(--accent); }
.scan-btn:disabled { cursor: default; }
.scan-btn.loading { color: var(--accent); border-color: var(--accent); }

.notice { padding: 12px 32px; font-size: 12px; border-bottom: 1px solid var(--border); }
.notice.err { color: var(--danger); }
.notice.warn { color: var(--text-muted); }

.tweet-count { padding: 10px 32px; font-size: 11px; color: var(--text-muted); border-bottom: 1px solid var(--border); }

.ticker-bar {
  padding: 14px 32px; border-bottom: 1px solid var(--border);
  display: flex; gap: 20px; align-items: center; flex-wrap: wrap;
}
.ticker-item { font-size: 12px; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; text-decoration: none; }
.ticker-item:hover { opacity: .7; }
.ticker-sym { color: var(--text-strong); font-weight: 500; }
.ticker-act { font-size: 10px; text-transform: uppercase; font-weight: 500; }
.ticker-cnt { color: var(--text-muted); font-size: 10px; }

.filter-bar {
  padding: 10px 32px; border-bottom: 1px solid var(--border);
  display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
}
.filter-bar .label { font-size: 11px; color: var(--text-muted); }
.filter-btn {
  background: none; border: none; font-size: 11px; color: var(--text-muted); padding: 2px 6px; border-radius: 2px; border: 1px solid transparent;
}
.filter-btn:hover { color: var(--text-strong); }
.filter-btn.on { background: var(--chip-bg); color: var(--text-strong); border: 1px solid var(--chip-border); }

.results-header {
  display: grid; grid-template-columns: 1fr 160px 110px 80px;
  padding: 12px 32px; border-bottom: 1px solid var(--border);
  font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .08em; gap: 20px;
}
.row {
  display: grid; grid-template-columns: 1fr 160px 110px 80px;
  padding: 16px 32px; border-bottom: 1px solid var(--border-light);
  align-items: start; gap: 20px;
}
.row.hidden { display: none; }

.sig-title { font-size: 13px; color: var(--text-strong); font-weight: 400; line-height: 1.4; }
.sig-summary { font-size: 12px; color: var(--text); line-height: 1.55; margin-top: 5px; }
.sig-links { margin-top: 6px; display: flex; gap: 8px; flex-wrap: wrap; }
.ext-link {
  font-size: 11px; color: var(--link); text-decoration: none;
  background: var(--bg-alt); border-radius: 2px;
}
.ext-link:hover { opacity: .7; }
.sig-meta { margin-top: 6px; display: flex; align-items: center; gap: 6px; }
.sig-cat { font-size: 10px; }
.conf-dot { width: 5px; height: 5px; border-radius: 50%; opacity: .7; display: inline-block; }
.ticker-cell { display: flex; flex-wrap: wrap; gap: 6px; padding-top: 2px; }
.ticker-tag { font-size: 12px; white-space: nowrap; font-weight: 500; text-decoration: none; }
.ticker-tag:hover { opacity: .7; }
.ticker-tag .a { font-size: 9px; opacity: .7; margin-left: 3px; text-transform: uppercase; font-weight: 400; }
.empty-dash { font-size: 12px; color: var(--text-muted); }
.source { font-size: 12px; color: var(--text); padding-top: 2px; }
.vlink { font-size: 11px; color: var(--link); text-decoration: none; }
.empty-state { padding: 48px 32px; font-size: 12px; color: var(--text-muted); text-align: center; }

.debug-section { padding: 16px 32px; border-top: 1px solid var(--border-light); }
.debug-toggle { background: none; border: none; color: var(--text-muted); font-size: 11px; padding: 0; }
.debug-content { margin-top: 8px; font-size: 11px; color: var(--text-muted); line-height: 1.7; white-space: pre-wrap; display: none; }
.debug-content.open { display: block; }
.debug-entry { margin-bottom: 10px; border-bottom: 1px solid var(--border-light); padding-bottom: 8px; }

.scan-actions { padding: 12px 32px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: center; }
.scan-actions .meta { font-size: 11px; color: var(--text-muted); flex: 1; }
.dl-btn {
  background: none; border: 1px solid var(--chip-border); border-radius: 2px;
  color: var(--text); font-size: 11px; padding: 4px 12px; cursor: pointer;
}
.dl-btn:hover { border-color: var(--text-muted); color: var(--text-strong); }

.footer { padding: 20px 32px; font-size: 10px; color: var(--text-muted); }

@media (max-width: 700px) {
  .results-header, .row { grid-template-columns: 1fr; gap: 8px; }
  .results-header span:not(:first-child) { display: none; }
  .row > *:nth-child(3), .row > *:nth-child(4) { display: inline; }
  .topbar, .controls, .notice, .tweet-count, .ticker-bar, .results-header, .row, .debug-section, .footer {
    padding-left: 16px; padding-right: 16px;
  }
}
</style>
</head>
<body>

<!-- key modal -->
<div class="modal-bg" id="modal">
  <div class="modal">
    <h3>Settings</h3>
    <p>Keys are stored in your browser only. Never sent anywhere except to their respective APIs.<br>
    Get a Twitter API key at <a href="https://twitterapi.io" target="_blank">twitterapi.io</a> ‚Äî $1 free credit on signup.</p>
    <label>Twitter API key (twitterapi.io)</label>
    <input type="password" id="twKeyInput" placeholder="your twitterapi.io key">
    <label>Anthropic API key</label>
    <input type="password" id="keyInput" placeholder="sk-ant-...">
    <label>Finance charts</label>
    <select id="financeProvider">
      <option value="yahoo">Yahoo Finance</option>
      <option value="google">Google Finance</option>
    </select>
    <div class="modal-actions">
      <button class="danger" id="clearKeyBtn" onclick="clearKeys()">clear all</button>
      <button onclick="closeModal()">cancel</button>
      <button onclick="saveKeys()">save</button>
    </div>
  </div>
</div>

<!-- preset modal -->
<div class="modal-bg" id="presetModal">
  <div class="modal">
    <h3>Manage presets</h3>
    <p>Create lists of accounts for quick scanning.</p>
    <label>Preset name</label>
    <input type="text" id="presetNameInput" placeholder="e.g. Crypto Alpha">
    <label>Accounts (comma-separated)</label>
    <textarea id="presetAccountsInput" rows="3" placeholder="account1, account2, account3"></textarea>
    <div class="modal-actions">
      <button onclick="closePresetModal()">cancel</button>
      <button onclick="savePreset()">save preset</button>
    </div>
    <div class="preset-list" id="presetList"></div>
  </div>
</div>

<div class="topbar">
  <div class="logo">
    <span class="dot" id="dot">‚ñ†</span>
    <span class="logo-text">sentry</span>
  </div>
  <div class="topbar-right">
    <span class="prog" id="prog"></span>
    <button class="top-btn" id="themeBtn" onclick="toggleTheme()">theme</button>
    <button class="top-btn" id="keyBtn" onclick="openModal()">settings</button>
  </div>
</div>

<div class="controls">
  <div class="input-row">
    <span class="at">@</span>
    <input type="text" id="acctInput" placeholder="add account" autocomplete="off">
    <button class="add-btn" id="addBtn">add</button>
  </div>
  <div class="presets-row" id="presetsRow">
    <span class="label">presets</span>
  </div>
  <div class="suggested" id="suggested"></div>
  <div class="ranges" id="rangesRow">
    <span class="label">range</span>
  </div>
  <div class="chips" id="chipsRow"></div>
</div>

<div id="notices"></div>
<div id="tweetCount"></div>
<div id="tickerBar"></div>
<div id="scanActions"></div>
<div id="filterBar"></div>
<div id="results"></div>
<div id="debugSection"></div>
<div class="footer">direct timeline ¬∑ not financial advice</div>

<script>
// --- Config ---
const SUGGESTED = ['zephyr_z9', 'jukan05', 'citrini7', 'nicholastreece', 'ayz_yzyz'];
const RANGES = [
  { label: 'today', days: 1 },
  { label: 'this week', days: 7 },
  { label: 'this month', days: 30 },
];
const CATEGORIES = ['Investment Idea', 'Tool / Product', 'Insight', 'Resource'];
const CONFIDENCES = ['high', 'medium', 'low'];
const CAT_C = { 'Investment Idea': '#1a7a1a', 'Tool / Product': '#2255bb', Insight: '#7733aa', Resource: '#8a6e10' };
const ACT_C = { buy: '#1a7a1a', sell: '#cc2222', hold: '#99850a', watch: '#2255bb' };
const CONF_C = { high: '#1a7a1a', medium: '#99850a', low: '#cc2222' };
const LS_TW = 'signal_twitter_key';
const LS_AN = 'signal_anthropic_key';
const LS_SCANS = 'signal_scan_history';
const LS_ACCOUNTS = 'signal_accounts';
const LS_PRESETS = 'signal_presets';
const LS_THEME = 'signal_theme';
const LS_FINANCE = 'signal_finance_provider';
const CORS_PROXY = 'https://sentry.tomaspalmeirim.workers.dev/?url=';

let accounts = [];
let range = 1;
let lastScanResult = null;
let busy = false;
let logs = [];
let filters = { category: null, confidence: null };
let scanAnimInterval = null;
const SCAN_FRAMES = ['‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë', '‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë', '‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë', '‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë', '‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë', '‚ñí‚ñì‚ñë‚ñë‚ñë‚ñë', '‚ñë‚ñí‚ñì‚ñë‚ñë‚ñë', '‚ñë‚ñë‚ñí‚ñì‚ñë‚ñë', '‚ñë‚ñë‚ñë‚ñí‚ñì‚ñë', '‚ñë‚ñë‚ñë‚ñë‚ñí‚ñì', '‚ñë‚ñë‚ñë‚ñë‚ñë‚ñí'];

// --- DOM ---
const $ = id => document.getElementById(id);
const esc = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };

// --- Theme ---
function getTheme() { return localStorage.getItem(LS_THEME) || 'light'; }
function setTheme(t) {
  localStorage.setItem(LS_THEME, t);
  document.documentElement.setAttribute('data-theme', t);
}
function toggleTheme() { setTheme(getTheme() === 'dark' ? 'light' : 'dark'); }

// --- Presets ---
function getPresets() { return JSON.parse(localStorage.getItem(LS_PRESETS) || '[]'); }
function savePresetsData(p) { localStorage.setItem(LS_PRESETS, JSON.stringify(p)); }
function loadPreset(name) {
  const preset = getPresets().find(p => p.name === name);
  if (preset) { accounts = [...preset.accounts]; saveAccounts(); render(); }
}
function deletePreset(name) {
  savePresetsData(getPresets().filter(p => p.name !== name));
  renderPresets();
  renderPresetList();
}
function renderPresets() {
  const el = $('presetsRow');
  const presets = getPresets();
  let h = '<span class="label">presets</span>';
  presets.forEach(p => {
    h += `<button class="preset-btn" onclick="loadPreset('${esc(p.name)}')">${esc(p.name)}</button>`;
  });
  h += `<button class="preset-manage" onclick="openPresetModal()">+</button>`;
  el.innerHTML = h;
}
function openPresetModal() {
  $('presetNameInput').value = '';
  $('presetAccountsInput').value = accounts.join(', ');
  renderPresetList();
  $('presetModal').classList.add('open');
  $('presetNameInput').focus();
}
function closePresetModal() {
  $('presetModal').classList.remove('open');
}
function savePreset() {
  const name = $('presetNameInput').value.trim();
  const accountsStr = $('presetAccountsInput').value;
  const accts = accountsStr.split(',').map(a => a.trim().replace(/^@/, '').toLowerCase()).filter(a => a);
  if (!name || !accts.length) return;
  const presets = getPresets().filter(p => p.name !== name);
  presets.push({ name, accounts: accts });
  savePresetsData(presets);
  renderPresets();
  renderPresetList();
  $('presetNameInput').value = '';
  $('presetAccountsInput').value = '';
}
function renderPresetList() {
  const el = $('presetList');
  const presets = getPresets();
  if (!presets.length) { el.innerHTML = '<p style="color:var(--text-muted);font-size:11px;margin-top:8px">No presets yet</p>'; return; }
  el.innerHTML = presets.map(p => `
    <div class="preset-list-item">
      <span>${esc(p.name)}<small>${p.accounts.length} accounts</small></span>
      <button onclick="deletePreset('${esc(p.name)}')">delete</button>
    </div>
  `).join('');
}
$('presetModal').addEventListener('click', e => { if (e.target === $('presetModal')) closePresetModal(); });
$('presetNameInput').addEventListener('keydown', e => { if (e.key === 'Enter') $('presetAccountsInput').focus(); });
$('presetAccountsInput').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); savePreset(); } });

// --- Account Persistence ---
function saveAccounts() { localStorage.setItem(LS_ACCOUNTS, JSON.stringify(accounts)); }
function loadAccounts() {
  const saved = localStorage.getItem(LS_ACCOUNTS);
  if (saved) accounts = JSON.parse(saved);
}

// --- API Keys & Settings ---
function getTwKey() { return localStorage.getItem(LS_TW) || ''; }
function getAnKey() { return localStorage.getItem(LS_AN) || ''; }
function bothKeys() { return !!(getTwKey() && getAnKey()); }
function getFinanceProvider() { return localStorage.getItem(LS_FINANCE) || 'yahoo'; }

function openModal() {
  $('twKeyInput').value = getTwKey();
  $('keyInput').value = getAnKey();
  $('financeProvider').value = getFinanceProvider();
  $('modal').classList.add('open');
  $('clearKeyBtn').style.display = (getTwKey() || getAnKey()) ? '' : 'none';
  setTimeout(() => $('twKeyInput').focus(), 50);
}
function closeModal() { $('modal').classList.remove('open'); }
function saveKeys() {
  const tw = $('twKeyInput').value.trim();
  const an = $('keyInput').value.trim();
  const fp = $('financeProvider').value;
  if (tw) localStorage.setItem(LS_TW, tw); else localStorage.removeItem(LS_TW);
  if (an) localStorage.setItem(LS_AN, an); else localStorage.removeItem(LS_AN);
  localStorage.setItem(LS_FINANCE, fp);
  updateKeyBtn();
  closeModal();
}
function clearKeys() {
  localStorage.removeItem(LS_TW);
  localStorage.removeItem(LS_AN);
  $('twKeyInput').value = '';
  $('keyInput').value = '';
  updateKeyBtn();
  closeModal();
}
function updateKeyBtn() {
  const ok = bothKeys();
  $('keyBtn').classList.toggle('set', ok);
  $('keyBtn').textContent = ok ? '‚úì settings' : 'settings';
}
$('modal').addEventListener('click', e => { if (e.target === $('modal')) closeModal(); });
$('twKeyInput').addEventListener('keydown', e => { if (e.key === 'Enter') $('keyInput').focus(); });
$('keyInput').addEventListener('keydown', e => { if (e.key === 'Enter') saveKeys(); });
updateKeyBtn();

// --- Accounts ---
function add(h) {
  const c = h.trim().replace(/^@/, '').toLowerCase();
  if (c && !accounts.includes(c)) accounts.push(c);
  $('acctInput').value = '';
  $('addBtn').classList.remove('vis');
  saveAccounts();
  render();
  $('acctInput').focus();
}
function rm(h) { accounts = accounts.filter(a => a !== h); saveAccounts(); render(); }

$('acctInput').addEventListener('input', function() {
  this.value = this.value.replace(/^@/, '');
  $('addBtn').classList.toggle('vis', this.value.trim().length > 0);
});
$('acctInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && $('acctInput').value.trim()) { e.preventDefault(); add($('acctInput').value); }
});
$('addBtn').addEventListener('click', () => { if ($('acctInput').value.trim()) add($('acctInput').value); });

// --- Render helpers ---
function render() { renderPresets(); renderSuggested(); renderRanges(); renderChips(); }

function renderSuggested() {
  const el = $('suggested');
  el.innerHTML = '';
  SUGGESTED.forEach(s => {
    const b = document.createElement('button');
    b.className = 'sug' + (accounts.includes(s) ? ' used' : '');
    b.textContent = s;
    if (!accounts.includes(s)) b.addEventListener('click', () => add(s));
    el.appendChild(b);
  });
}

function renderRanges() {
  const row = $('rangesRow');
  while (row.children.length > 1) row.removeChild(row.lastChild);
  RANGES.forEach((r, i) => {
    const b = document.createElement('button');
    b.className = 'rng' + (range === i ? ' on' : '');
    b.textContent = r.label;
    b.addEventListener('click', () => { range = i; renderRanges(); });
    row.appendChild(b);
  });
  row.classList.toggle('mb', accounts.length > 0);
}

function renderChips() {
  const el = $('chipsRow');
  el.innerHTML = '';
  el.classList.toggle('vis', accounts.length > 0);
  accounts.forEach(a => {
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = `@${esc(a)}<span class="x">‚úï</span>`;
    chip.querySelector('.x').addEventListener('click', () => rm(a));
    el.appendChild(chip);
  });
  const btn = document.createElement('button');
  btn.className = busy ? 'scan-btn loading' : 'scan-btn';
  btn.id = 'scanBtn';
  btn.disabled = busy;
  btn.textContent = busy ? SCAN_FRAMES[0] : 'scan';
  btn.addEventListener('click', run);
  el.appendChild(btn);
  
  // Start/stop animation
  if (busy && !scanAnimInterval) {
    let frame = 0;
    scanAnimInterval = setInterval(() => {
      frame = (frame + 1) % SCAN_FRAMES.length;
      const b = $('scanBtn');
      if (b) b.textContent = SCAN_FRAMES[frame];
    }, 80);
  } else if (!busy && scanAnimInterval) {
    clearInterval(scanAnimInterval);
    scanAnimInterval = null;
  }
}

function setLoading(v) {
  busy = v;
  $('dot').classList.toggle('loading', v);
  renderChips();
}
function setProg(t) { $('prog').textContent = t; }

// --- Twitter API (twitterapi.io) ---
async function fetchTweets(account, days) {
  const key = getTwKey();
  if (!key) throw new Error('no Twitter API key');

  const cutoff = new Date(Date.now() - days * 86400000);
  console.log(`[${account}] Fetching tweets since ${cutoff.toISOString()} (${days} days)`);
  const allTweets = [];
  let cursor = null;
  let pages = 0;
  const MAX_PAGES = 5;

  while (pages < MAX_PAGES) {
    const params = new URLSearchParams({ userName: account });
    if (cursor) params.set('cursor', cursor);

    const targetUrl = `https://api.twitterapi.io/twitter/user/last_tweets?${params}`;
    const fetchUrl = CORS_PROXY + encodeURIComponent(targetUrl);

    const res = await fetch(fetchUrl, {
      method: 'GET',
      headers: {
        'X-API-Key': key,
        'Accept': 'application/json',
      },
    });

    if (res.status === 401 || res.status === 403) {
      const body = await res.text().catch(() => '');
      throw new Error(`Auth error ${res.status}: ${body.slice(0, 100) || 'invalid key'}`);
    }
    if (res.status === 429) {
      await new Promise(r => setTimeout(r, 5000));
      pages++; // count it to prevent infinite loop
      continue;
    }
    if (!res.ok) {
      const body = await res.text().catch(() => '');
      throw new Error(`API ${res.status}: ${body.slice(0, 150) || res.statusText}`);
    }

    let data;
    try {
      const text = await res.text();
      console.log(`[${account}] Raw API response:`, text.slice(0, 500));
      data = JSON.parse(text);
    } catch (e) {
      throw new Error('Invalid JSON from API');
    }

    // API nests tweets inside data.data
    const apiData = data.data || data;
    console.log(`[${account}] Parsed data:`, { status: data.status, tweetCount: apiData.tweets?.length, hasNext: apiData.has_next_page });

    if (data.status === 'error' || (data.status !== 'success' && data.message)) {
      throw new Error(data.message || data.msg || 'API error');
    }

    const tweets = apiData.tweets || [];
    if (!tweets.length) {
      console.log(`[${account}] No tweets in response`);
      break;
    }

    let hitCutoff = false;
    for (const tw of tweets) {
      const created = new Date(tw.createdAt);
      if (created < cutoff) { hitCutoff = true; break; }
      allTweets.push(tw);
    }

    if (hitCutoff) break;
    if (!apiData.has_next_page || !apiData.next_cursor) break;
    cursor = apiData.next_cursor;
    pages++;
    // Delay between pagination requests
    await new Promise(r => setTimeout(r, 300));
  }

  return allTweets;
}

function formatTweetForAnalysis(tw) {
  const date = new Date(tw.createdAt).toISOString().slice(0, 16).replace('T', ' ');
  const engagement = `${tw.likeCount || 0}‚ô• ${tw.retweetCount || 0}‚Üª ${tw.viewCount || 0}üëÅ`;
  const url = tw.url || `https://x.com/i/status/${tw.id}`;
  let text = tw.text || '';

  // collect external URLs (exclude twitter/x.com links)
  const externalLinks = [];
  if (tw.entities?.urls) {
    for (const u of tw.entities.urls) {
      if (u.url && u.expanded_url) {
        text = text.replace(u.url, u.expanded_url);
        // filter out twitter/x.com internal links
        if (!u.expanded_url.match(/^https?:\/\/(twitter\.com|x\.com|t\.co)\//)) {
          externalLinks.push(u.expanded_url);
        }
      }
    }
  }

  const parts = [`[${date}] ${text}`, `engagement: ${engagement}`, `tweet_url: ${url}`];
  if (externalLinks.length) parts.push(`external_links: ${externalLinks.join(', ')}`);
  if (tw.isReply) parts.push(`(reply to @${tw.inReplyToUsername || 'unknown'})`);
  if (tw.quoted_tweet) parts.push(`(quoting: "${tw.quoted_tweet.text?.slice(0, 120) || ''}")`);

  return parts.join('\n');
}

// --- Anthropic API ---
async function anthropicCall(body, retries) {
  const key = getAnKey();
  if (!key) throw new Error('no Anthropic API key');
  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': key,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true',
        },
        body: JSON.stringify(body),
      });
      if (res.status === 429 || res.status === 529) {
        await new Promise(r => setTimeout(r, Math.min(2000 * (attempt + 1), 6000)));
        continue;
      }
      const data = await res.json();
      console.log('Anthropic response:', res.status, data);
      if (data.error?.type === 'overloaded_error' || data.error?.type === 'rate_limit_error') {
        await new Promise(r => setTimeout(r, Math.min(2000 * (attempt + 1), 6000)));
        continue;
      }
      if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));
      return data;
    } catch (e) {
      if (e.message.includes('no Anthropic') || e.message.includes('no API')) throw e;
      if (attempt >= retries) throw e;
      await new Promise(r => setTimeout(r, 2000 * (attempt + 1)));
    }
  }
  throw new Error('max retries reached');
}

function extractText(content) {
  if (!content) return '';
  if (typeof content === 'string') return content;
  if (!Array.isArray(content)) return '';
  return content.filter(b => b.type === 'text' && b.text).map(b => b.text).join('\n');
}

// --- Main flow ---
async function run() {
  if (!accounts.length || busy) return;
  if (!bothKeys()) { openModal(); return; }

  setLoading(true);
  $('notices').innerHTML = '';
  $('tweetCount').innerHTML = '';
  $('tickerBar').innerHTML = '';
  $('scanActions').innerHTML = '';
  $('filterBar').innerHTML = '';
  $('results').innerHTML = '';
  $('debugSection').innerHTML = '';
  logs = [];

  const days = RANGES[range].days;
  const done = { count: 0 };
  const accountTweets = [];

  try {
    // Step 1: Fetch tweets from all accounts (sequential to avoid rate limits)
    for (const a of accounts) {
      setProg(`${a} ${done.count + 1}/${accounts.length}`);
      try {
        const tweets = await fetchTweets(a, days);
        done.count++;
        accountTweets.push({ account: a, tweets, error: null });
      } catch (e) {
        done.count++;
        accountTweets.push({ account: a, tweets: [], error: e.message });
      }
      // Small delay between accounts to avoid rate limits
      if (done.count < accounts.length) await new Promise(r => setTimeout(r, 500));
    }

    // Tally
    const totalTweets = accountTweets.reduce((s, a) => s + a.tweets.length, 0);
    const fails = accountTweets.filter(a => a.error);
    const empties = accountTweets.filter(a => !a.error && !a.tweets.length);

    // Log
    for (const a of accountTweets) {
      logs.push({
        a: a.account,
        len: a.tweets.length,
        pre: a.error
          ? `ERROR: ${a.error}`
          : a.tweets.slice(0, 3).map(t => t.text?.slice(0, 100)).join(' | ') || '(no tweets in range)',
      });
    }

    if (totalTweets === 0) {
      let msg = 'no tweets found for this time range';
      if (fails.length) msg += ` ‚Äî errors: ${fails.map(f => `${f.account} (${f.error})`).join(', ')}`;
      $('notices').innerHTML = `<div class="notice err">${esc(msg)}</div>`;
      setLoading(false); setProg(''); renderDebug(); return;
    }

    // Show notices
    const parts = [];
    if (fails.length) parts.push(`<span style="color:#cc3333">errors: ${esc(fails.map(f => f.account).join(', '))}</span>`);
    if (empties.length) parts.push(`<span style="color:#cc8800">no posts: ${esc(empties.map(e => e.account).join(', '))}</span>`);
    if (parts.length) $('notices').innerHTML = `<div class="notice warn">${parts.join(' ¬∑ ')}</div>`;

    // Tweet count
    const perAccount = accountTweets.filter(a => a.tweets.length).map(a => `${a.account}: ${a.tweets.length}`).join(', ');
    $('tweetCount').innerHTML = `<div class="tweet-count">${totalTweets} tweets fetched (${perAccount})</div>`;

    // Step 2: Format and send to Claude for analysis
    setProg('analyzing...');

    const combined = accountTweets
      .filter(a => a.tweets.length)
      .map(a => {
        const header = `=== @${a.account} (${a.tweets.length} tweets) ===`;
        const body = a.tweets.map(formatTweetForAnalysis).join('\n---\n');
        return `${header}\n${body}`;
      })
      .join('\n\n======\n\n');

    const data = await anthropicCall({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 8192,
      messages: [{
        role: 'user',
        content: `You are a world-class financial analyst. Extract actionable trading signals from these tweets. Be thorough ‚Äî every tweet with a tradeable opinion counts.

${combined}

Return a JSON array. Each signal:
- "title": A compelling, specific headline like a Bloomberg terminal alert. Lead with the ticker/company when relevant. Examples: "NVDA: Supply constraints ease, buy signal", "Nanya, Winbond: Memory supercycle beneficiaries", "AT&S undervalued despite momentum". NO generic titles.
- "summary": 1-2 punchy sentences with the core thesis and reasoning. Be specific about why.
- "category": "Investment Idea" | "Tool / Product" | "Insight" | "Resource"
- "source": twitter handle (no @)
- "confidence": "high" | "medium" | "low" ‚Äî based on engagement + source credibility
- "tickers": [{symbol: "$TICKER", action: "buy"|"sell"|"hold"|"watch"}] ‚Äî Extract ALL tickers mentioned. Use Yahoo Finance format: US stocks just the symbol (e.g. "$AAPL", "$UBER"), Taiwan add .TW (e.g. "$2408.TW"), Hong Kong add .HK, Japan add .T, Korea add .KS, crypto just symbol (e.g. "$BTC").
- "tweet_url": exact tweet_url from data
- "links": external URLs mentioned (articles, substacks). Empty array if none.

Return ONLY valid JSON array. No markdown, no explanation.`,
      }],
    }, 1);

    const txt = extractText(data.content);
    logs.push({ a: '_analysis', len: txt.length, pre: txt.slice(0, 400) });

    let signals = [];
    try {
      const m = txt.replace(/```json|```/g, '').trim().match(/\[[\s\S]*\]/);
      signals = m ? JSON.parse(m[0]) : [];
    } catch { signals = []; }

    // Store scan result
    lastScanResult = {
      date: new Date().toISOString(),
      range: RANGES[range].label,
      days: RANGES[range].days,
      accounts: [...accounts],
      totalTweets,
      signals,
      rawTweets: accountTweets.map(a => ({ account: a.account, tweets: a.tweets })),
    };
    saveScan(lastScanResult);

    renderTickers(signals);
    renderSignals(signals);
    renderDebug();
  } catch (e) {
    $('notices').innerHTML = `<div class="notice err">${esc(e.message)}</div>`;
    renderDebug();
  } finally {
    setLoading(false);
    setProg('');
  }
}

// --- Scan Storage ---
function saveScan(scan) {
  const history = JSON.parse(localStorage.getItem(LS_SCANS) || '[]');
  history.unshift(scan);
  // Keep last 20 scans
  if (history.length > 20) history.pop();
  localStorage.setItem(LS_SCANS, JSON.stringify(history));
}

function getScanHistory() {
  return JSON.parse(localStorage.getItem(LS_SCANS) || '[]');
}

function downloadScan(scan, filename) {
  const blob = new Blob([JSON.stringify(scan, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename || `scan-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function downloadLastScan() {
  if (!lastScanResult) return;
  const date = new Date(lastScanResult.date).toISOString().slice(0, 16).replace('T', '-').replace(':', '');
  downloadScan(lastScanResult, `sentry-${date}.json`);
}

// --- Renderers ---
function tickerUrl(sym) {
  const s = sym.replace(/^\$/, '').toUpperCase();
  if (getFinanceProvider() === 'google') {
    // Google Finance needs exchange, try to infer from suffix
    if (s.endsWith('.TW')) return `https://www.google.com/finance/quote/${s.replace('.TW', '')}:TPE?window=6M`;
    if (s.endsWith('.HK')) return `https://www.google.com/finance/quote/${s.replace('.HK', '')}:HKG?window=6M`;
    if (s.endsWith('.T')) return `https://www.google.com/finance/quote/${s.replace('.T', '')}:TYO?window=6M`;
    if (s.endsWith('.KS')) return `https://www.google.com/finance/quote/${s.replace('.KS', '')}:KRX?window=6M`;
    return `https://www.google.com/finance/quote/${s}?window=6M`;
  }
  return `https://finance.yahoo.com/quote/${encodeURIComponent(s)}`;
}

function renderTickers(signals) {
  const map = {};
  signals.forEach(r => (r.tickers || []).forEach(t => {
    const k = (t.symbol || '').toUpperCase();
    if (!k) return;
    if (!map[k]) map[k] = { s: k, acts: new Set(), n: 0 };
    map[k].acts.add(t.action); map[k].n++;
  }));
  const list = Object.values(map).sort((a, b) => b.n - a.n);
  const el = $('tickerBar');
  if (!list.length) { el.innerHTML = ''; el.className = ''; return; }
  el.className = 'ticker-bar';
  el.innerHTML = list.map(t => {
    const pa = ['sell', 'buy', 'hold', 'watch'].find(a => t.acts.has(a)) || 'watch';
    const url = tickerUrl(t.s);
    return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="ticker-item"><span class="ticker-sym">${esc(t.s)}</span><span class="ticker-act" style="color:${ACT_C[pa]}">${pa}</span>${t.n > 1 ? `<span class="ticker-cnt">√ó${t.n}</span>` : ''}</a>`;
  }).join('');
}

function renderScanActions() {
  const el = $('scanActions');
  if (!lastScanResult) { el.innerHTML = ''; return; }
  const d = new Date(lastScanResult.date);
  const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  el.innerHTML = `<div class="scan-actions">
    <span class="meta">${dateStr} ¬∑ ${lastScanResult.accounts.length} accounts ¬∑ ${lastScanResult.totalTweets} tweets ¬∑ ${lastScanResult.signals.length} signals</span>
    <button class="dl-btn" onclick="downloadLastScan()">‚Üì download json</button>
  </div>`;
}

function renderSignals(signals) {
  const el = $('results');
  filters = { category: null, confidence: null }; // reset filters
  if (!signals.length) { el.innerHTML = '<div class="empty-state">no signals extracted</div>'; renderScanActions(); renderFilters(); return; }
  let h = '<div class="results-header"><span>signal</span><span>tickers</span><span>source</span><span style="text-align:right">link</span></div>';
  signals.forEach((item, i) => {
    const cc = CAT_C[item.category] || '#888';
    const fc = CONF_C[item.confidence] || '#ccc';
    const tks = (item.tickers && item.tickers.length)
      ? item.tickers.map(t => {
          const url = tickerUrl(t.symbol || '');
          return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="ticker-tag" style="color:${ACT_C[t.action] || '#666'}">${esc(t.symbol)}<span class="a">${t.action}</span></a>`;
        }).join('')
      : '<span class="empty-dash">‚Äî</span>';
    const lnk = item.tweet_url
      ? `<a href="${esc(item.tweet_url)}" target="_blank" rel="noopener noreferrer" class="vlink">see tweet</a>`
      : '<span class="empty-dash">‚Äî</span>';
    const extLinks = (item.links && item.links.length)
      ? item.links.map(l => `<a href="${esc(l)}" target="_blank" rel="noopener noreferrer" class="ext-link">${esc(new URL(l).hostname.replace('www.',''))}</a>`).join(' ')
      : '';
    h += `<div class="row" data-category="${esc(item.category || '')}" data-confidence="${esc(item.confidence || '')}" style="animation-delay:${i * 40}ms">
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px">
          <span class="sig-title">${esc(item.title || '')}</span>
        </div>
        <div class="sig-summary">${esc(item.summary || '')}</div>
        ${extLinks ? `<div class="sig-links">${extLinks}</div>` : ''}
        <div class="sig-meta">
          <span class="sig-cat" style="color:${cc}">${esc((item.category || '').toLowerCase())}</span>
          <span class="conf-dot" style="background:${fc}"></span>
        </div>
      </div>
      <div class="ticker-cell">${tks}</div>
      <span class="source">@${esc((item.source || '').replace(/^@/, ''))}</span>
      <div style="text-align:right;padding-top:2px">${lnk}</div>
    </div>`;
  });
  el.innerHTML = h;
  renderScanActions();
  renderFilters();
  el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderDebug() {
  const el = $('debugSection');
  if (!logs.length) { el.innerHTML = ''; return; }
  el.innerHTML = `<div class="debug-section">
    <button class="debug-toggle" id="debugToggle">‚ñ∏ debug</button>
    <div class="debug-content" id="debugContent">
      ${logs.map(l => `<div class="debug-entry"><span style="color:#777">@${esc(l.a)}</span> ‚Äî ${l.len} ${l.a === '_analysis' ? 'chars' : 'tweets'}<div style="color:#bbb;margin-top:2px">${esc(l.pre)}</div></div>`).join('')}
    </div>
  </div>`;
  $('debugToggle').addEventListener('click', function() {
    const c = $('debugContent');
    const open = c.classList.toggle('open');
    this.textContent = (open ? '‚ñæ' : '‚ñ∏') + ' debug';
  });
}

// --- Filters ---
function setFilter(type, value) {
  filters[type] = filters[type] === value ? null : value;
  applyFilters();
  renderFilters();
}

function applyFilters() {
  const rows = document.querySelectorAll('#results .row');
  rows.forEach(row => {
    const cat = row.dataset.category;
    const conf = row.dataset.confidence;
    const catMatch = !filters.category || cat === filters.category;
    const confMatch = !filters.confidence || conf === filters.confidence;
    row.classList.toggle('hidden', !(catMatch && confMatch));
  });
}

function renderFilters() {
  const el = $('filterBar');
  if (!lastScanResult || !lastScanResult.signals.length) { el.innerHTML = ''; return; }
  
  let h = '<div class="filter-bar"><span class="label">filter</span>';
  CATEGORIES.forEach(c => {
    const on = filters.category === c ? ' on' : '';
    h += `<button class="filter-btn${on}" onclick="setFilter('category','${c}')">${c.toLowerCase()}</button>`;
  });
  h += '<span style="color:var(--border);margin:0 4px">|</span>';
  CONFIDENCES.forEach(c => {
    const on = filters.confidence === c ? ' on' : '';
    h += `<button class="filter-btn${on}" onclick="setFilter('confidence','${c}')">${c}</button>`;
  });
  h += '</div>';
  el.innerHTML = h;
}

// --- Init ---
setTheme(getTheme());
loadAccounts();
render();
</script>
</body>
</html>