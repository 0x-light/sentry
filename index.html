<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>sentry</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #ffffff; --bg-alt: #f5f5f5; --text: #555; --text-strong: #222; --text-strong-rgb: 34,34,34; --text-muted: #999;
  --border: #eee; --border-light: #f5f5f5; --chip-bg: transparent; --chip-border: #ddd;
  --green: #1a7a1a; --green-10: rgba(26,122,26,0.1);
  --red: #cc2222; --red-10: rgba(204,34,34,0.1);
  --blue: #2255bb; --blue-10: rgba(34,85,187,0.1);
  --purple: #7733aa; --purple-10: rgba(119,51,170,0.1);
  --amber: #996600; --amber-10: rgba(153,102,0,0.1);
}
[data-theme="dark"] {
  --bg: #0a0a0a; --bg-alt: #151515; --text: #888; --text-strong: #ddd; --text-strong-rgb: 221,221,221; --text-muted: #555;
  --border: #222; --border-light: #1a1a1a; --chip-bg: #151515; --chip-border: #333;
  --green: #4ade80; --green-10: rgba(74,222,128,0.1);
  --red: #ff4b4b; --red-10: rgba(248,113,113,0.1);
  --blue: #60a5fa; --blue-10: rgba(96,165,250,0.1);
  --purple: #a78bfa; --purple-10: rgba(167,139,250,0.1);
  --amber: #fbbf24; --amber-10: rgba(251,191,36,0.1);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 13px; -webkit-font-smoothing: antialiased;
}
[data-font="system"], [data-font="system"] * {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
/* Text case - default is lowercase */
/* Lowercase mode - UI elements only */
[data-case="lower"] .logo-text, [data-case="lower"] .top-btn, [data-case="lower"] .add-btn,
[data-case="lower"] .preset-btn, [data-case="lower"] .preset-manage, [data-case="lower"] .sug,
[data-case="lower"] .rng, [data-case="lower"] .chip, [data-case="lower"] .chip-summary, 
[data-case="lower"] .chip-header, [data-case="lower"] .chip-x, [data-case="lower"] .clear-btn,
[data-case="lower"] .scan-btn, [data-case="lower"] .sig-cat,
[data-case="lower"] .debug-toggle, [data-case="lower"] .dl-btn, [data-case="lower"] .footer,
[data-case="lower"] .empty-state, [data-case="lower"] .see-post, [data-case="lower"] .modal h3, [data-case="lower"] label,
[data-case="lower"] .modal-actions button, [data-case="lower"] .preset-list-item button,
[data-case="lower"] input::placeholder, [data-case="lower"] textarea::placeholder { text-transform: lowercase; }
::selection { background: var(--bg-alt); color: var(--green); }
input::placeholder { color: var(--text-muted); }
button { font-family: inherit; cursor: pointer; }

.topbar {
  padding: 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.logo { display: flex; align-items: center; gap: 8px; }
.dot { font-size: 8px; color: var(--text-strong); line-height: 1; }
.dot.loading { animation: pulse 0.6s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
.logo-text { font-size: 13px; font-weight: 500; color: var(--text-strong); }
.topbar-right { display: flex; align-items: center; gap: 16px; }
.top-btn { background: none; border: none; font-size: 13px; color: var(--text-muted); padding: 3px 6px; }
.top-btn:hover { color: var(--text); }
.top-btn.warn { color: var(--amber); }

/* modal */
.modal-bg {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 100;
  align-items: center; justify-content: center; padding: 16px;
}
.modal-bg.open { display: flex; }
.modal {
  background: var(--bg); border: 1px solid var(--border);
  padding: 24px; width: 100%; max-width: 420px; max-height: calc(100vh - 32px); overflow-y: auto;
}
.modal h3 { font-size: 15px; font-weight: 500; color: var(--text-strong); margin-bottom: 8px; }
.modal p { font-size: 13px; color: var(--text-muted); margin-bottom: 24px; line-height: 1.6; }
.modal p a { color: var(--blue); text-decoration: none; }
.modal p a:hover { text-decoration: underline; }
.modal label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 6px; margin-top: 16px; text-transform: uppercase; }
.modal label:first-of-type { margin-top: 0; }
.reset-prompt { background: none; border: none; color: var(--text-muted); font-size: 11px; cursor: pointer; margin-left: 8px; text-transform: lowercase; }
.reset-prompt:hover { color: var(--text-strong); }
.modal input, .modal select, .modal textarea {
  width: 100%; border: 1px solid var(--chip-border); padding: 10px 12px;
  font-family: inherit; font-size: 13px; color: var(--text-strong); outline: none;
  background: var(--bg); resize: vertical;
}
.modal select {
  padding-right: 36px; cursor: pointer;
  appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
}
[data-theme="dark"] .modal select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
}
.modal input:focus, .modal textarea:focus { border-color: var(--text-muted); }
.modal-actions { display: flex; gap: 8px; margin-top: 24px; justify-content: flex-end; }
.modal-actions button {
  background: none; border: 1px solid var(--chip-border);
  font-size: 13px; padding: 3px 6px; color: var(--text);
}
.modal-actions button:hover { border-color: var(--text-muted); color: var(--text-strong); }
.modal-actions button:last-child { background: var(--text-strong); border-color: var(--text-strong); color: var(--bg); }
.modal-actions button:last-child:hover { opacity: 0.9; }
.modal-actions button.danger { color: var(--red); margin-right: auto; }
.modal-actions button.danger:hover { border-color: var(--red); }
.preset-list { margin-top: 24px; border-top: 1px solid var(--border); padding-top: 16px; }
.preset-list-item {
  display: flex; align-items: center; justify-content: space-between; padding: 10px 0;
  border-bottom: 1px solid var(--border-light); font-size: 13px;
}
.preset-list-item:last-child { border-bottom: none; }
.preset-list-item span { color: var(--text-strong); }
.preset-list-item small { color: var(--text-muted); margin-left: 8px; font-size: 12px; }
.preset-list-item.editing { background: var(--bg-alt); margin: 0 -8px; padding: 10px 8px; }
.preset-list-actions { display: flex; gap: 8px; }
.preset-list-item button { background: none; border: none; color: var(--text-muted); font-size: 12px; padding: 4px 0; }
.preset-list-item button:hover { color: var(--text-strong); }
.preset-list-item button.danger:hover { color: var(--red); }

.controls { padding: 20px; border-bottom: 1px solid var(--border); }
.input-row { display: flex; gap: 6px; align-items: center; margin-bottom: 20px; }
.input-row .at { color: var(--text-muted); font-size: 13px; }
.input-row input {
  flex: 1; background: transparent; border: none; outline: none;
  color: var(--text-strong); font-size: 13px; font-family: inherit;
}
.add-btn { background: none; border: none; color: var(--text-muted); font-size: 13px; padding: 3px 6px; display: none; }
.add-btn.vis { display: inline; }

.presets-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
.preset-btn {
  background: none; border: 1px solid var(--chip-border);
  color: var(--text-muted); font-size: 13px; padding: 3px 6px;
}
.preset-btn:hover { color: var(--text-strong); border-color: var(--text-muted); }
.preset-btn.active { color: var(--text-strong); border-color: var(--text-strong); }
.preset-manage { background: none; border: none; color: var(--text-muted); font-size: 13px; padding: 3px 6px; }
.preset-manage:hover { color: var(--text-strong); }

.suggested { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
.suggested:empty { margin-bottom: 0; }
.sug { background: none; border: none; color: var(--text-muted); font-size: 13px; }
.sug:hover { color: var(--text-strong); }
.sug.used { opacity: .35; cursor: default; }

.ranges { display: flex; gap: 16px; align-items: center; }
.ranges.mb { margin-bottom: 20px; }
.rng {
  background: none; border: none; border-bottom: 1px solid transparent;
  color: var(--text-muted); font-size: 13px;
}
.rng:hover { color: var(--text-strong); }
.rng.on { color: var(--text-strong); border-bottom-color: var(--text-strong); }

.chips { display: none; align-items: center; gap: 8px; flex-wrap: wrap; }
.chips.vis { display: flex; }
.chip {
  font-size: 13px; color: var(--text-strong); background: var(--bg-alt); border: 1px solid var(--bg-alt);
  padding: 3px 6px; display: inline-flex; align-items: center; gap: 6px;
}
.chip-group.expanded .chip { border-color: rgba(var(--text-strong-rgb), 0.1); }
.chip .x { cursor: pointer; color: var(--text-muted); font-size: 10px; }
.chip-group { display: inline-flex; align-items: center; gap: 4px; margin-right: 4px; background: var(--bg-alt); }
.chip-group.expanded { flex-wrap: wrap; }
.chip-summary { cursor: pointer; color: var(--text-strong); border: none; background: none; padding: 3px 0 3px 6px; }
.chip-summary:hover { color: var(--green); }
.chip-count { color: var(--text-muted); font-size: 13px; }
.chip-header { cursor: pointer; color: var(--text-strong); border: none; background: none; padding: 3px 6px; font-size: 13px; }
.chip-header:hover { color: var(--green); }
.chip-x { background: none; border: none; color: var(--text-muted); font-size: 10px; padding: 2px 6px 2px 0px; cursor: pointer; }
.chip-x:hover { color: var(--red); }
.clear-btn { background: none; border: none; color: var(--text-muted); font-size: 13px; padding: 3px 6px; }
.clear-btn:hover { color: var(--red); }
.scan-btn {
  margin-left: auto; background: var(--text-strong); border: 1px solid var(--text-strong); color: var(--bg); font-size: 13px; padding: 3px 6px;
}
.scan-btn:hover:not(:disabled) { opacity: .8; }
.scan-btn:disabled { opacity: .5; cursor: default; }

.notice { padding: 12px 20px; font-size: 13px; border-bottom: 1px solid var(--border); }
.notice.err { color: var(--red); }
.notice.warn { color: var(--text-muted); }

.tweet-count { padding: 10px 20px; font-size: 13px; color: var(--text-muted); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
.tweet-count:empty { display: none; }
.tweet-count .dl-btn { margin-left: auto; }
.dots::after { content: ''; animation: dots 1.2s steps(4, end) infinite; }
@keyframes dots { 0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; } }

.ticker-bar {
  padding: 14px 20px; border-bottom: 1px solid var(--border);
  display: flex; gap: 20px; align-items: center; flex-wrap: wrap;
}
.ticker-item { font-size: 13px; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; text-decoration: none; }
.ticker-item:hover { opacity: .7; }
.ticker-sym { color: var(--text-strong); font-weight: 500; }
.ticker-act { font-size: 10px; text-transform: uppercase; font-weight: 500; }
.ticker-cnt { color: var(--text-muted); font-size: 10px; }

.filter-bar {
  padding: 12px 20px; border-bottom: 1px solid var(--border);
  display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
}

.signal {
  padding: 20px; border-bottom: 1px solid var(--border);
}
.signal.hidden { display: none; }
.sig-top { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.sig-top a { color: var(--text-muted); text-decoration: none; }
.sig-top a:hover { color: var(--text-strong); }
.sig-tickers { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
.ticker-tag { font-size: 13px; font-weight: 500; text-decoration: none; }
.ticker-tag:hover { opacity: .7; }
.ticker-tag .a { font-size: 9px; opacity: .7; margin-left: 3px; text-transform: uppercase; font-weight: 400; }
.sig-title { font-size: 14px; color: var(--text-strong); font-weight: 500; line-height: 1.4; margin-bottom: 6px; }
.sig-summary { font-size: 13px; color: var(--text); line-height: 1.55; }
.sig-links { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
.ext-link { font-size: 13px; color: var(--blue); text-decoration: none; }
.ext-link:hover { opacity: .7; }
.sig-bottom { margin-top: 10px; font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
.sig-cat { color: inherit; }
.see-post { color: var(--text-muted); text-decoration: none; font-size: 13px; }
.see-post:hover { color: var(--text-strong); }
.tweet-tooltip {
  position: fixed; z-index: 1000; max-width: 320px; padding: 12px 14px;
  background: var(--text-strong); color: var(--bg); font-size: 13px; line-height: 1.5;
  pointer-events: none; opacity: 0; border: 1px solid var(--text-strong);
}
.tweet-tooltip.vis { opacity: 1; }
.empty-state { padding: 48px 20px; font-size: 13px; color: var(--text-muted); text-align: center; }

.debug-section { padding: 16px 20px; border-top: 1px solid var(--border-light); }
.debug-toggle { background: none; border: none; color: var(--text-muted); font-size: 13px; padding: 3px 6px; }
.debug-content { margin-top: 8px; font-size: 13px; color: var(--text-muted); line-height: 1.7; white-space: pre-wrap; display: none; }
.debug-content.open { display: block; }
.debug-entry { margin-bottom: 10px; border-bottom: 1px solid var(--border-light); padding-bottom: 8px; }

.scan-actions { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: center; }
.scan-actions .meta { font-size: 13px; color: var(--text-muted); flex: 1; }
.dl-btn {
  background: none; border: none;
  color: var(--text-muted); font-size: 13px; padding: 3px 6px; cursor: pointer;
}
.dl-btn:hover { color: var(--text-strong); }

.footer { padding: 20px; font-size: 10px; color: var(--text-muted); }
.footer:empty { display: none; }

@media (max-width: 700px) {
  .topbar, .controls, .notice, .tweet-count, .ticker-bar, .scan-actions, .filter-bar, .signal, .debug-section, .footer {
    padding-left: 16px; padding-right: 16px;
  }
  .hide-mobile { display: none; }
  input, textarea, select { font-size: 16px !important; } /* prevent iOS zoom on focus */
  .modal-bg { align-items: flex-end; padding: 0; }
  .modal { max-width: 100%; max-height: 85vh; border: none; border-top: 1px solid var(--border); padding: 20px; }
  .modal-actions { flex-direction: column-reverse; }
  .modal-actions button { width: 100%; padding: 12px; }
  .modal-actions button.danger { margin-right: 0; margin-top: 8px; }
}
</style>
</head>
<body>

<!-- key modal -->
<div class="modal-bg" id="modal">
  <div class="modal">
    <h3>Settings</h3>
    <p>Keys are stored in your browser only and are never sent anywhere except to their respective APIs.<br>
    Get an X/Twitter API key at <a href="https://twitterapi.io" target="_blank">twitterapi.io</a>.<br>
    Get an Anthropic API key at <a href="https://platform.claude.com/settings/keys" target="_blank">platform.claude.com</a>.</p>
    <label>Twitter API key (twitterapi.io)</label>
    <input type="password" id="twKeyInput" placeholder="Your twitterapi.io key">
    <label>Anthropic API key</label>
    <input type="password" id="keyInput" placeholder="sk-ant-...">
    <label>Finance charts</label>
    <select id="financeProvider">
      <option value="yahoo">Yahoo Finance</option>
      <option value="google">Google Finance</option>
    </select>
    <label>Font</label>
    <select id="fontProvider">
      <option value="mono">Monospace</option>
      <option value="system">System</option>
    </select>
    <label>Text style</label>
    <select id="caseProvider">
      <option value="lower">lowercase</option>
      <option value="sentence">Sentence case</option>
    </select>
    <label>Analyst prompt <button type="button" class="reset-prompt" onclick="resetPrompt()">reset</button></label>
    <textarea id="promptInput" style="height:150px" placeholder="Custom instructions for the AI analyst..."></textarea>
    <div class="modal-actions">
      <button class="danger" id="clearKeyBtn" onclick="clearKeys()">Clear all</button>
      <button onclick="closeModal()">Cancel</button>
      <button onclick="saveKeys()">Save</button>
    </div>
  </div>
</div>

<!-- preset modal -->
<div class="modal-bg" id="presetModal">
  <div class="modal">
    <h3>Manage presets</h3>
    <p>Create lists of accounts for quick scanning.</p>
    <label>Preset name</label>
    <input type="text" id="presetNameInput" placeholder="E.g. Commodities">
    <label>Accounts (comma-separated)</label>
    <textarea id="presetAccountsInput" style="height:175px" placeholder="account1, account2, account3"></textarea>
    <div class="modal-actions">
      <button onclick="closePresetModal()">Cancel</button>
      <button onclick="savePreset()">Save preset</button>
    </div>
    <div class="preset-list" id="presetList"></div>
  </div>
</div>

<div class="topbar">
  <div class="logo">
    <span class="dot" id="dot">â– </span>
    <span class="logo-text">Sentry</span>
  </div>
  <div class="topbar-right">
    <button class="top-btn" id="themeBtn" onclick="toggleTheme()">Theme</button>
    <button class="top-btn" id="keyBtn" onclick="openModal()">Settings</button>
  </div>
</div>

<div class="controls">
  <div class="input-row">
    <span class="at">@</span>
    <input type="text" id="acctInput" placeholder="Add account" autocomplete="off">
    <button class="add-btn" id="addBtn">Add</button>
  </div>
  <div class="presets-row" id="presetsRow"></div>
  <div class="suggested" id="suggested"></div>
  <div class="ranges" id="rangesRow"></div>
  <div class="chips" id="chipsRow"></div>
</div>

<div id="tweetCount"></div>
<div id="notices"></div>
<div id="tickerBar"></div>
<div id="scanActions"></div>
<div id="filterBar"></div>
<div id="results"></div>
<div id="debugSection"></div>
<div class="footer" id="footer"></div>
<div class="tweet-tooltip" id="tweetTooltip"></div>

<script>
// --- Config ---
const DEFAULT_PRESETS = [
  { name: 'tradfi', accounts: ['ayz_yzyz', 'citrini7', 'jukan05', 'nicholastreece', 'zephyr_z9'] },
  { name: 'crypto', accounts: ['0xaporia', '0xGeeGee', '0xkyle__', '0xNairolf', '__bleeker', 'AggrNews', 'ahboyash', 'awawat', 'BambouClub', 'based16z', 'blknoiz06', 'Bluntz_Capital', 'burstingbagel', 'c0xswain', 'Cbb0fe', 'Cheshire_Cap', 'choffstein', 'chortly', 'chrisgrx_', 'CL207', 'cobie', 'Cryptopathic', 'danny_xbt', 'deaftrader1', 'defi_monk', 'DeFiyst', 'definalist', 'DegenPing', 'delucinator', 'DonAlt', 'Evan_ss6', 'FoftyPawlow', 'gametheorizing', 'goodalexander', 'hansolar21', 'HsakaTrades', 'Husslin_', 'ieaturfoods', 'inversebrah', 'jeff_w1098', 'kwaker_oats_', 'lBattleRhino', 'maruushae', 'mert', 'mlmabc', 'NyuuRoe', 'PaperFlow8', 'pet3rpan_', 'PineAnalytics', 'pk79z', 'QwQiao', 'redphonecrypto', 'riddle245', 'rodeo_crypro', 'RunnerXBT', 'saliencexbt', 'sershokunin', 'TangTrades', 'Techno_Revenant', 'tetra_gamma', 'TheCryptoNexus', 'ThinkingUSD', 'trading_axe', 'TreeNewsFeed', 'tzedonn', 'velo_xyz', 'xmgnr', 'zoomerfied'] },
];
const MAX_RECENTS = 10; // how many recent accounts to show
const RANGES = [
  { label: 'Today', days: 1 },
  { label: 'This week', days: 7 },
  { label: 'This month', days: 30 },
];
const CATEGORIES = ['Investment Idea', 'Tool / Product', 'Insight', 'Resource'];
const CAT_C = { 'Investment Idea': 'var(--green)', 'Tool / Product': 'var(--blue)', Insight: 'var(--purple)', Resource: 'var(--amber)' };
const ACT_C = { buy: 'var(--green)', sell: 'var(--red)', hold: 'var(--amber)', watch: 'var(--blue)', mixed: 'var(--purple)' };
const LS_TW = 'signal_twitter_key';
const LS_AN = 'signal_anthropic_key';
const LS_SCANS = 'signal_scan_history';
const LS_CURRENT = 'signal_current_scan';
const LS_PROMPT = 'signal_custom_prompt';
const DEFAULT_PROMPT = `You are a world-class financial analyst. Extract actionable trading signals from these tweets. Be thorough â€” every tweet with a tradeable opinion counts.

Return a JSON array. Each signal:
- "title": A compelling, specific headline like a Bloomberg terminal alert. Lead with the ticker/company when relevant. Examples: "NVDA: Supply constraints ease, buy signal", "Nanya, Winbond: Memory supercycle beneficiaries", "AT&S undervalued despite momentum". NO generic titles.
- "summary": 1-2 punchy sentences with the core thesis and reasoning. Be specific about why.
- "category": "Investment Idea" | "Tool / Product" | "Insight" | "Resource"
- "source": twitter handle (no @)
- "tickers": [{symbol: "$TICKER", action: "buy"|"sell"|"hold"|"watch"}] â€” Extract ALL tickers mentioned. Use Yahoo Finance format: US stocks just the symbol (e.g. "$AAPL", "$UBER"), Taiwan add .TW (e.g. "$2408.TW"), Hong Kong add .HK, Japan add .T, Korea add .KS, crypto just symbol (e.g. "$BTC").
- "tweet_url": exact tweet_url from data
- "links": external URLs mentioned (articles, substacks). Empty array if none.

Return ONLY valid JSON array. No markdown, no explanation.`;
const LS_ACCOUNTS = 'signal_accounts';
const LS_LOADED_PRESETS = 'signal_loaded_presets';
const LS_PRESETS = 'signal_presets';
const LS_THEME = 'signal_theme';
const LS_FINANCE = 'signal_finance_provider';
const LS_FONT = 'signal_font';
const LS_CASE = 'signal_case';
const LS_RECENTS = 'signal_recent_accounts';
const CORS_PROXY = 'https://sentry.tomaspalmeirim.workers.dev/?url=';

let customAccounts = [];      // manually added accounts
let loadedPresets = [];       // array of preset names currently loaded
let expandedPresets = new Set(); // which preset groups are expanded
let range = 1;
let lastScanResult = null;
let busy = false;
let logs = [];
let filters = { category: null };

// Get all accounts (presets + custom) for scanning
function getAllAccounts() {
  const all = [...customAccounts];
  const presets = getPresets();
  for (const name of loadedPresets) {
    const p = presets.find(p => p.name === name);
    if (p) all.push(...p.accounts);
  }
  return [...new Set(all)]; // dedupe
}

function hasAnyAccounts() {
  return customAccounts.length > 0 || loadedPresets.length > 0;
}

// --- DOM ---
const $ = id => document.getElementById(id);
const esc = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };

// --- Theme ---
function getTheme() { return localStorage.getItem(LS_THEME) || 'light'; }
function setTheme(t) {
  localStorage.setItem(LS_THEME, t);
  document.documentElement.setAttribute('data-theme', t);
}
function toggleTheme() { setTheme(getTheme() === 'dark' ? 'light' : 'dark'); }

// --- Presets ---
function getPresets() {
  const stored = localStorage.getItem(LS_PRESETS);
  if (!stored) {
    // Initialize with defaults on first load
    localStorage.setItem(LS_PRESETS, JSON.stringify(DEFAULT_PRESETS));
    return DEFAULT_PRESETS;
  }
  return JSON.parse(stored);
}
function savePresetsData(p) { localStorage.setItem(LS_PRESETS, JSON.stringify(p)); }
function loadPreset(name) {
  const preset = getPresets().find(p => p.name === name);
  if (!preset) return;
  
  // Toggle preset on/off
  if (loadedPresets.includes(name)) {
    loadedPresets = loadedPresets.filter(n => n !== name);
    expandedPresets.delete(name);
  } else {
    loadedPresets.push(name);
  }
  saveLoadedPresets();
  render();
}

function unloadPreset(name) {
  loadedPresets = loadedPresets.filter(n => n !== name);
  expandedPresets.delete(name);
  saveLoadedPresets();
  render();
}

function togglePresetExpand(name) {
  if (expandedPresets.has(name)) {
    expandedPresets.delete(name);
  } else {
    expandedPresets.add(name);
  }
  renderChips();
}
function deletePreset(name) {
  savePresetsData(getPresets().filter(p => p.name !== name));
  renderPresets();
  renderPresetList();
}
function renderPresets() {
  const el = $('presetsRow');
  const presets = getPresets();
  let h = '';
  presets.forEach(p => {
    const active = loadedPresets.includes(p.name) ? ' active' : '';
    h += `<button class="preset-btn${active}" onclick="loadPreset('${esc(p.name)}')">${esc(p.name)}</button>`;
  });
  h += `<button class="preset-manage" onclick="openPresetModal()">+</button>`;
  el.innerHTML = h;
}
let editingPresetName = null; // track if editing an existing preset

function openPresetModal() {
  editingPresetName = null;
  $('presetNameInput').value = '';
  $('presetAccountsInput').value = getAllAccounts().join(', ');
  renderPresetList();
  $('presetModal').classList.add('open');
  $('presetNameInput').focus();
}
function closePresetModal() {
  editingPresetName = null;
  $('presetModal').classList.remove('open');
}
function editPreset(name) {
  const preset = getPresets().find(p => p.name === name);
  if (!preset) return;
  editingPresetName = name;
  $('presetNameInput').value = preset.name;
  $('presetAccountsInput').value = preset.accounts.join(', ');
  $('presetNameInput').focus();
  renderPresetList();
}
function savePreset() {
  const name = $('presetNameInput').value.trim();
  const accountsStr = $('presetAccountsInput').value;
  const accts = accountsStr.split(',').map(a => a.trim().replace(/^@/, '').toLowerCase()).filter(a => a);
  if (!name || !accts.length) return;
  
  let presets = getPresets();
  if (editingPresetName) {
    // Update existing preset
    presets = presets.filter(p => p.name !== editingPresetName);
  }
  presets = presets.filter(p => p.name !== name);
  presets.push({ name, accounts: accts });
  savePresetsData(presets);
  
  // Update loaded presets if name changed
  if (editingPresetName && editingPresetName !== name && loadedPresets.includes(editingPresetName)) {
    loadedPresets = loadedPresets.map(n => n === editingPresetName ? name : n);
    saveLoadedPresets();
  }
  
  editingPresetName = null;
  renderPresets();
  renderPresetList();
  render();
  $('presetNameInput').value = '';
  $('presetAccountsInput').value = '';
}
function renderPresetList() {
  const el = $('presetList');
  const presets = getPresets();
  if (!presets.length) { el.innerHTML = '<p style="color:var(--text-muted);font-size:13px;margin-top:8px">No presets yet</p>'; return; }
  el.innerHTML = presets.map(p => {
    const isEditing = editingPresetName === p.name;
    return `
    <div class="preset-list-item${isEditing ? ' editing' : ''}">
      <span>${esc(p.name)}<small>${p.accounts.length} accounts</small></span>
      <div class="preset-list-actions">
        <button onclick="editPreset('${esc(p.name)}')">${isEditing ? 'Editing' : 'Edit'}</button>
        <button class="danger" onclick="deletePreset('${esc(p.name)}')">Delete</button>
      </div>
    </div>
  `}).join('');
}
// Only close modal if mousedown AND mouseup both happen on backdrop
let presetModalMouseDownTarget = null;
$('presetModal').addEventListener('mousedown', e => { presetModalMouseDownTarget = e.target; });
$('presetModal').addEventListener('click', e => {
  if (e.target === $('presetModal') && presetModalMouseDownTarget === $('presetModal')) closePresetModal();
  presetModalMouseDownTarget = null;
});
$('presetNameInput').addEventListener('keydown', e => { if (e.key === 'Enter') $('presetAccountsInput').focus(); });
$('presetAccountsInput').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); savePreset(); } });

// --- Account Persistence ---
function saveAccounts() { localStorage.setItem(LS_ACCOUNTS, JSON.stringify(customAccounts)); }
function loadAccountsData() {
  const saved = localStorage.getItem(LS_ACCOUNTS);
  if (saved) customAccounts = JSON.parse(saved);
}
function saveLoadedPresets() { localStorage.setItem(LS_LOADED_PRESETS, JSON.stringify(loadedPresets)); }
function loadLoadedPresets() {
  const saved = localStorage.getItem(LS_LOADED_PRESETS);
  if (saved) loadedPresets = JSON.parse(saved);
}

// --- Recent Accounts ---
function getRecents() {
  return JSON.parse(localStorage.getItem(LS_RECENTS) || '[]');
}
function addToRecents(accounts) {
  let recents = getRecents();
  // Add new accounts to front, remove duplicates
  accounts.forEach(a => {
    recents = recents.filter(r => r !== a);
    recents.unshift(a);
  });
  // Keep only MAX_RECENTS
  recents = recents.slice(0, MAX_RECENTS);
  localStorage.setItem(LS_RECENTS, JSON.stringify(recents));
}

// --- API Keys & Settings ---
function getTwKey() { return localStorage.getItem(LS_TW) || ''; }
function getAnKey() { return localStorage.getItem(LS_AN) || ''; }
function bothKeys() { return !!(getTwKey() && getAnKey()); }
function getFinanceProvider() { return localStorage.getItem(LS_FINANCE) || 'yahoo'; }
function getFont() { return localStorage.getItem(LS_FONT) || 'mono'; }
function setFont(f) {
  localStorage.setItem(LS_FONT, f);
  document.documentElement.setAttribute('data-font', f);
}
function getCase() { return localStorage.getItem(LS_CASE) || 'lower'; }
function setCase(c) {
  localStorage.setItem(LS_CASE, c);
  document.documentElement.setAttribute('data-case', c);
}
function getPrompt() { return localStorage.getItem(LS_PROMPT) || DEFAULT_PROMPT; }
function setPrompt(p) { localStorage.setItem(LS_PROMPT, p); }
function resetPrompt() { $('promptInput').value = DEFAULT_PROMPT; }

function openModal() {
  $('twKeyInput').value = getTwKey();
  $('keyInput').value = getAnKey();
  $('financeProvider').value = getFinanceProvider();
  $('fontProvider').value = getFont();
  $('caseProvider').value = getCase();
  $('promptInput').value = getPrompt();
  $('modal').classList.add('open');
  $('clearKeyBtn').style.display = (getTwKey() || getAnKey()) ? '' : 'none';
  setTimeout(() => $('twKeyInput').focus(), 50);
}
function closeModal() { $('modal').classList.remove('open'); }
function saveKeys() {
  const tw = $('twKeyInput').value.trim();
  const an = $('keyInput').value.trim();
  const fp = $('financeProvider').value;
  const font = $('fontProvider').value;
  const textCase = $('caseProvider').value;
  const prompt = $('promptInput').value.trim();
  if (tw) localStorage.setItem(LS_TW, tw); else localStorage.removeItem(LS_TW);
  if (an) localStorage.setItem(LS_AN, an); else localStorage.removeItem(LS_AN);
  localStorage.setItem(LS_FINANCE, fp);
  setFont(font);
  setCase(textCase);
  setPrompt(prompt || DEFAULT_PROMPT);
  updateKeyBtn();
  closeModal();
}
function clearKeys() {
  localStorage.removeItem(LS_TW);
  localStorage.removeItem(LS_AN);
  $('twKeyInput').value = '';
  $('keyInput').value = '';
  updateKeyBtn();
  closeModal();
}
function updateKeyBtn() {
  const ok = bothKeys();
  $('keyBtn').classList.toggle('warn', !ok);
  $('keyBtn').textContent = 'Settings';
}
// Only close modal if mousedown AND mouseup both happen on backdrop
let modalMouseDownTarget = null;
$('modal').addEventListener('mousedown', e => { modalMouseDownTarget = e.target; });
$('modal').addEventListener('click', e => {
  if (e.target === $('modal') && modalMouseDownTarget === $('modal')) closeModal();
  modalMouseDownTarget = null;
});
$('twKeyInput').addEventListener('keydown', e => { if (e.key === 'Enter') $('keyInput').focus(); });
$('keyInput').addEventListener('keydown', e => { if (e.key === 'Enter') saveKeys(); });
updateKeyBtn();

// --- Accounts ---
function add(h) {
  const c = h.trim().replace(/^@/, '').toLowerCase();
  if (c && !customAccounts.includes(c)) customAccounts.push(c);
  $('acctInput').value = '';
  $('addBtn').classList.remove('vis');
  saveAccounts();
  render();
  $('acctInput').focus();
}
function rmCustom(h) {
  customAccounts = customAccounts.filter(a => a !== h);
  saveAccounts();
  render();
}

$('acctInput').addEventListener('input', function() {
  this.value = this.value.replace(/^@/, '');
  $('addBtn').classList.toggle('vis', this.value.trim().length > 0);
});
$('acctInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && $('acctInput').value.trim()) { e.preventDefault(); add($('acctInput').value); }
});
$('addBtn').addEventListener('click', () => { if ($('acctInput').value.trim()) add($('acctInput').value); });

// --- Render helpers ---
function render() { renderPresets(); renderSuggested(); renderRanges(); renderChips(); }

function renderSuggested() {
  const el = $('suggested');
  const recents = getRecents();
  if (!recents.length) { el.innerHTML = ''; return; }
  
  const allAccounts = getAllAccounts();
  el.innerHTML = '';
  
  recents.forEach(s => {
    const b = document.createElement('button');
    b.className = 'sug' + (allAccounts.includes(s) ? ' used' : '');
    b.textContent = s;
    if (!allAccounts.includes(s)) b.addEventListener('click', () => add(s));
    el.appendChild(b);
  });
}

function renderRanges() {
  const row = $('rangesRow');
  row.innerHTML = '';
  RANGES.forEach((r, i) => {
    const b = document.createElement('button');
    b.className = 'rng' + (range === i ? ' on' : '');
    b.textContent = r.label;
    b.addEventListener('click', () => { range = i; renderRanges(); });
    row.appendChild(b);
  });
  row.classList.toggle('mb', hasAnyAccounts());
}

function renderChips() {
  const el = $('chipsRow');
  el.innerHTML = '';
  el.classList.toggle('vis', hasAnyAccounts());
  
  const presets = getPresets();
  const COLLAPSE_THRESHOLD = 5;
  
  // Render each loaded preset as a group
  loadedPresets.forEach(name => {
    const preset = presets.find(p => p.name === name);
    if (!preset) return;
    
    const isExpanded = expandedPresets.has(name);
    const canCollapse = preset.accounts.length > COLLAPSE_THRESHOLD;
    
    if (!isExpanded) {
      // Collapsed - show summary
      const group = document.createElement('span');
      group.className = 'chip-group collapsed';
      group.innerHTML = `<button class="chip chip-summary" onclick="togglePresetExpand('${esc(name)}')">${esc(name)} <span class="chip-count">(${preset.accounts.length})</span></button><button class="chip-x" onclick="unloadPreset('${esc(name)}')">âœ•</button>`;
      el.appendChild(group);
    } else {
      // Expanded - show all accounts in this preset (sorted alphabetically)
      const group = document.createElement('span');
      group.className = 'chip-group expanded';
      let h = `<button class="chip chip-header" onclick="togglePresetExpand('${esc(name)}')">${esc(name)} âˆ’</button>`;
      [...preset.accounts].sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())).forEach(a => {
        h += `<span class="chip">@${esc(a)}</span>`;
      });
      h += `<button class="chip-x" onclick="unloadPreset('${esc(name)}')">âœ•</button>`;
      group.innerHTML = h;
      el.appendChild(group);
    }
  });
  
  // Render custom accounts
  customAccounts.forEach(a => {
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = `@${esc(a)}<span class="x" onclick="rmCustom('${esc(a)}')">âœ•</span>`;
    el.appendChild(chip);
  });
  
  // Clear all button
  if (loadedPresets.length > 0 || customAccounts.length > 0) {
    const clearBtn = document.createElement('button');
    clearBtn.className = 'clear-btn';
    clearBtn.textContent = 'Clear';
    clearBtn.addEventListener('click', clearAllAccounts);
    el.appendChild(clearBtn);
  }
  
  const btn = document.createElement('button');
  btn.className = 'scan-btn';
  btn.disabled = busy;
  btn.textContent = busy ? 'Scanning...' : 'Scan';
  btn.addEventListener('click', run);
  el.appendChild(btn);
}

function clearAllAccounts() {
  customAccounts = [];
  loadedPresets = [];
  expandedPresets.clear();
  saveAccounts();
  saveLoadedPresets();
  render();
}

function setLoading(v) {
  busy = v;
  $('dot').classList.toggle('loading', v);
  renderChips();
}
function setStatus(t, animate = false, showDownload = false) {
  const el = $('tweetCount');
  if (!t) { el.innerHTML = ''; return; }
  const dl = showDownload ? `<button class="dl-btn" onclick="downloadLastScan()">â†“ Download JSON</button>` : '';
  el.innerHTML = `<div class="tweet-count">${t}${animate ? '<span class="dots"></span>' : ''}${dl}</div>`;
}

// --- Twitter API (twitterapi.io) ---
async function fetchTweets(account, days) {
  const key = getTwKey();
  if (!key) throw new Error('no Twitter API key');

  const cutoff = new Date(Date.now() - days * 86400000);
  console.log(`[${account}] Fetching tweets since ${cutoff.toISOString()} (${days} days)`);
  const allTweets = [];
  let cursor = null;
  let pages = 0;
  const MAX_PAGES = 5;

  while (pages < MAX_PAGES) {
    const params = new URLSearchParams({ userName: account });
    if (cursor) params.set('cursor', cursor);

    const targetUrl = `https://api.twitterapi.io/twitter/user/last_tweets?${params}`;
    const fetchUrl = CORS_PROXY + encodeURIComponent(targetUrl);

    const res = await fetch(fetchUrl, {
      method: 'GET',
      headers: {
        'X-API-Key': key,
        'Accept': 'application/json',
      },
    });

    if (res.status === 401 || res.status === 403) {
      const body = await res.text().catch(() => '');
      throw new Error(`Auth error ${res.status}: ${body.slice(0, 100) || 'invalid key'}`);
    }
    if (res.status === 429) {
      await new Promise(r => setTimeout(r, 5000));
      pages++; // count it to prevent infinite loop
      continue;
    }
    if (!res.ok) {
      const body = await res.text().catch(() => '');
      throw new Error(`API ${res.status}: ${body.slice(0, 150) || res.statusText}`);
    }

    let data;
    try {
      const text = await res.text();
      console.log(`[${account}] Raw API response:`, text.slice(0, 500));
      data = JSON.parse(text);
    } catch (e) {
      throw new Error('Invalid JSON from API');
    }

    // API nests tweets inside data.data
    const apiData = data.data || data;
    console.log(`[${account}] Parsed data:`, { status: data.status, tweetCount: apiData.tweets?.length, hasNext: apiData.has_next_page });

    if (data.status === 'error' || (data.status !== 'success' && data.message)) {
      throw new Error(data.message || data.msg || 'API error');
    }

    const tweets = apiData.tweets || [];
    if (!tweets.length) {
      console.log(`[${account}] No tweets in response`);
      break;
    }

    let hitCutoff = false;
    for (const tw of tweets) {
      const created = new Date(tw.createdAt);
      if (created < cutoff) { hitCutoff = true; break; }
      allTweets.push(tw);
    }

    if (hitCutoff) break;
    if (!apiData.has_next_page || !apiData.next_cursor) break;
    cursor = apiData.next_cursor;
    pages++;
    // Delay between pagination requests
    await new Promise(r => setTimeout(r, 100));
  }

  return allTweets;
}

// Remove invalid Unicode (orphan surrogates) that break JSON
function sanitizeText(str) {
  if (!str) return '';
  // Remove lone surrogates (characters in range U+D800 to U+DFFF that aren't properly paired)
  return str.replace(/[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?<![\uD800-\uDBFF])[\uDC00-\uDFFF]/g, '');
}

function formatTweetForAnalysis(tw) {
  const date = new Date(tw.createdAt).toISOString().slice(0, 16).replace('T', ' ');
  const engagement = `${tw.likeCount || 0}â™¥ ${tw.retweetCount || 0}â†» ${tw.viewCount || 0}ðŸ‘`;
  const url = tw.url || `https://x.com/i/status/${tw.id}`;
  let text = sanitizeText(tw.text || '');

  // collect external URLs (exclude twitter/x.com links)
  const externalLinks = [];
  if (tw.entities?.urls) {
    for (const u of tw.entities.urls) {
      if (u.url && u.expanded_url) {
        const expandedUrl = sanitizeText(u.expanded_url);
        text = text.replace(u.url, expandedUrl);
        // filter out twitter/x.com internal links
        if (!expandedUrl.match(/^https?:\/\/(twitter\.com|x\.com|t\.co)\//)) {
          externalLinks.push(expandedUrl);
        }
      }
    }
  }

  const parts = [`[${date}] ${text}`, `engagement: ${engagement}`, `tweet_url: ${url}`];
  if (externalLinks.length) parts.push(`external_links: ${externalLinks.join(', ')}`);
  if (tw.isReply) parts.push(`(reply to @${tw.inReplyToUsername || 'unknown'})`);
  if (tw.quoted_tweet) parts.push(`(quoting: "${tw.quoted_tweet.text?.slice(0, 120) || ''}")`);

  return parts.join('\n');
}

// --- Anthropic API ---
async function anthropicCall(body, retries) {
  const key = getAnKey();
  if (!key) throw new Error('no Anthropic API key');
  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': key,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true',
        },
        body: JSON.stringify(body),
      });
      if (res.status === 429 || res.status === 529) {
        await new Promise(r => setTimeout(r, Math.min(2000 * (attempt + 1), 6000)));
        continue;
      }
      const data = await res.json();
      console.log('Anthropic response:', res.status, data);
      // Log full error details
      if (data.error) console.error('Anthropic error:', JSON.stringify(data.error, null, 2));
      if (data.error?.type === 'overloaded_error' || data.error?.type === 'rate_limit_error') {
        await new Promise(r => setTimeout(r, Math.min(2000 * (attempt + 1), 6000)));
        continue;
      }
      // Don't retry quota/billing/model errors
      if (data.error?.type === 'invalid_request_error') {
        if (data.error?.message?.includes('quota')) {
          throw new Error(data.error.message);
        }
        if (data.error?.message?.includes('prompt is too long')) {
          throw new Error(`Too many tweets to analyze in one request. Try selecting fewer accounts or a shorter time range.`);
        }
      }
      if (data.error?.type === 'not_found_error') {
        throw new Error(`Model not available. Please check your API key has access to Claude 3.5 Sonnet.`);
      }
      if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));
      return data;
    } catch (e) {
      if (e.message.includes('no Anthropic') || e.message.includes('no API')) throw e;
      if (attempt >= retries) throw e;
      await new Promise(r => setTimeout(r, 2000 * (attempt + 1)));
    }
  }
  throw new Error('max retries reached');
}

function extractText(content) {
  if (!content) return '';
  if (typeof content === 'string') return content;
  if (!Array.isArray(content)) return '';
  return content.filter(b => b.type === 'text' && b.text).map(b => b.text).join('\n');
}

// --- Main flow ---
async function run() {
  const accounts = getAllAccounts();
  if (!accounts.length || busy) return;
  if (!bothKeys()) { openModal(); return; }

  setLoading(true);
  $('notices').innerHTML = '';
  $('tweetCount').innerHTML = '';
  $('tickerBar').innerHTML = '';
  $('scanActions').innerHTML = '';
  $('filterBar').innerHTML = '';
  $('results').innerHTML = '';
  $('debugSection').innerHTML = '';
  logs = [];
  
  // Save custom accounts to recents
  if (customAccounts.length) {
    addToRecents(customAccounts);
    renderSuggested();
  }

  const days = RANGES[range].days;
  const done = { count: 0 };
  const accountTweets = [];

  try {
    // Step 1: Fetch tweets in parallel batches of 2
    const BATCH_SIZE = 2;
    for (let i = 0; i < accounts.length; i += BATCH_SIZE) {
      const batch = accounts.slice(i, i + BATCH_SIZE);
      setStatus(`Fetching ${i + 1}-${Math.min(i + batch.length, accounts.length)} of ${accounts.length}`, true);
      
      const results = await Promise.all(batch.map(async (a) => {
        try {
          const tweets = await fetchTweets(a, days);
          return { account: a, tweets, error: null };
        } catch (e) {
          return { account: a, tweets: [], error: e.message };
        }
      }));
      
      accountTweets.push(...results);
      done.count += batch.length;
      
      // Small delay between batches
      if (i + BATCH_SIZE < accounts.length) await new Promise(r => setTimeout(r, 200));
    }

    // Tally
    const totalTweets = accountTweets.reduce((s, a) => s + a.tweets.length, 0);
    const fails = accountTweets.filter(a => a.error);
    const empties = accountTweets.filter(a => !a.error && !a.tweets.length);

    // Log
    for (const a of accountTweets) {
      logs.push({
        a: a.account,
        len: a.tweets.length,
        pre: a.error
          ? `ERROR: ${a.error}`
          : a.tweets.slice(0, 3).map(t => t.text?.slice(0, 100)).join(' | ') || '(no tweets in range)',
      });
    }

    if (totalTweets === 0) {
      let msg = 'no tweets found for this time range';
      if (fails.length) msg += ` â€” errors: ${fails.map(f => `${f.account} (${f.error})`).join(', ')}`;
      $('notices').innerHTML = `<div class="notice err">${esc(msg)}</div>`;
      setLoading(false); setStatus(''); renderDebug(); return;
    }

    // Show notices
    const parts = [];
    if (fails.length) parts.push(`<span style="color:var(--red)">errors: ${esc(fails.map(f => f.account).join(', '))}</span>`);
    if (empties.length) parts.push(`<span style="color:var(--amber)">No posts: ${esc(empties.map(e => e.account).join(', '))}</span>`);
    if (parts.length) $('notices').innerHTML = `<div class="notice warn">${parts.join(' Â· ')}</div>`;

    // Tweet count
    setStatus(`${totalTweets} tweets fetched Â· Analyzing`, true);

    // Step 2: Format and send to Claude for analysis (with batching if needed)
    const prompt = getPrompt();
    const accountData = accountTweets.filter(a => a.tweets.length);
    
    // Max input tokens: 200k, use 160k to be safe (1 token â‰ˆ 4 chars = 640k chars)
    const MAX_BATCH_CHARS = 640000;
    const promptChars = prompt.length;
    
    let allSignals = [];
    let currentBatch = [];
    let currentBatchSize = promptChars;
    let batchNum = 1;
    
    for (const a of accountData) {
      const header = `=== @${a.account} (${a.tweets.length} tweets) ===`;
      const body = a.tweets.map(formatTweetForAnalysis).join('\n---\n');
      const accountText = `${header}\n${body}`;
      const accountSize = accountText.length + 20; // +20 for separators
      
      // If adding this account exceeds limit, process current batch first
      if (currentBatch.length > 0 && currentBatchSize + accountSize > MAX_BATCH_CHARS) {
        setStatus(`Analyzing batch ${batchNum}/${Math.ceil(accountData.length / currentBatch.length)}`, true);
        const batchContent = sanitizeText(`${prompt}\n\n${currentBatch.join('\n\n======\n\n')}`);
        const data = await anthropicCall({
          model: 'claude-3-5-sonnet-20240620',
          max_tokens: 16384,
          messages: [{ role: 'user', content: batchContent }],
        }, 1);
        
        const txt = extractText(data.content);
        logs.push({ a: `_batch${batchNum}`, len: txt.length, pre: txt.slice(0, 400) });
        
        try {
          const m = txt.replace(/```json|```/g, '').trim().match(/\[[\s\S]*\]/);
          const batchSignals = m ? JSON.parse(m[0]) : [];
          allSignals.push(...batchSignals);
        } catch (e) {
          console.warn(`Batch ${batchNum} parse error:`, e);
        }
        
        // Reset for next batch
        currentBatch = [];
        currentBatchSize = promptChars;
        batchNum++;
      }
      
      currentBatch.push(accountText);
      currentBatchSize += accountSize;
    }
    
    // Process final batch
    if (currentBatch.length > 0) {
      if (batchNum > 1) setStatus(`Analyzing batch ${batchNum}/${batchNum}`, true);
      else setStatus(`${totalTweets} tweets fetched Â· Analyzing`, true);
      
      const batchContent = sanitizeText(`${prompt}\n\n${currentBatch.join('\n\n======\n\n')}`);
      const data = await anthropicCall({
        model: 'claude-3-5-sonnet-20240620',
        max_tokens: 16384,
        messages: [{ role: 'user', content: batchContent }],
      }, 1);
      
      const txt = extractText(data.content);
      logs.push({ a: `_batch${batchNum}`, len: txt.length, pre: txt.slice(0, 400) });
      
      try {
        const m = txt.replace(/```json|```/g, '').trim().match(/\[[\s\S]*\]/);
        const batchSignals = m ? JSON.parse(m[0]) : [];
        allSignals.push(...batchSignals);
      } catch (e) {
        console.warn(`Batch ${batchNum} parse error:`, e);
      }
    }
    
    const signals = allSignals;

    // Store scan result
    lastScanResult = {
      date: new Date().toISOString(),
      range: RANGES[range].label,
      days: RANGES[range].days,
      accounts: [...accounts],
      totalTweets,
      signals,
      rawTweets: accountTweets.map(a => ({ account: a.account, tweets: a.tweets })),
    };
    saveScan(lastScanResult);

    // Update status to final count with full info
    const d = new Date();
    const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    setStatus(`${dateStr} Â· <span class="hide-mobile">${accounts.length} accounts Â· ${totalTweets} tweets Â· </span>${signals.length} signals`, false, true);

    renderTickers(signals);
    renderSignals(signals);
    renderDebug();
  } catch (e) {
    setStatus(''); // Clear analyzing status
    $('notices').innerHTML = `<div class="notice err">${esc(e.message)}</div>`;
    renderDebug();
  } finally {
    setLoading(false);
  }
}

// --- Scan Storage ---
function saveScan(scan) {
  const history = JSON.parse(localStorage.getItem(LS_SCANS) || '[]');
  history.unshift(scan);
  // Keep last 20 scans
  if (history.length > 20) history.pop();
  localStorage.setItem(LS_SCANS, JSON.stringify(history));
  // Also save as current for page refresh persistence
  localStorage.setItem(LS_CURRENT, JSON.stringify(scan));
}

function loadCurrentScan() {
  const saved = localStorage.getItem(LS_CURRENT);
  if (!saved) return null;
  try { return JSON.parse(saved); } catch { return null; }
}

function getScanHistory() {
  return JSON.parse(localStorage.getItem(LS_SCANS) || '[]');
}

function downloadScan(scan, filename) {
  const blob = new Blob([JSON.stringify(scan, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename || `scan-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function downloadLastScan() {
  if (!lastScanResult) return;
  const date = new Date(lastScanResult.date).toISOString().slice(0, 16).replace('T', '-').replace(':', '');
  downloadScan(lastScanResult, `sentry-${date}.json`);
}

// --- Renderers ---
function tickerUrl(sym) {
  const s = sym.replace(/^\$/, '').toUpperCase();
  if (getFinanceProvider() === 'google') {
    // Google Finance needs exchange, try to infer from suffix
    if (s.endsWith('.TW')) return `https://www.google.com/finance/quote/${s.replace('.TW', '')}:TPE?window=6M`;
    if (s.endsWith('.HK')) return `https://www.google.com/finance/quote/${s.replace('.HK', '')}:HKG?window=6M`;
    if (s.endsWith('.T')) return `https://www.google.com/finance/quote/${s.replace('.T', '')}:TYO?window=6M`;
    if (s.endsWith('.KS')) return `https://www.google.com/finance/quote/${s.replace('.KS', '')}:KRX?window=6M`;
    return `https://www.google.com/finance/quote/${s}?window=6M`;
  }
  return `https://finance.yahoo.com/quote/${encodeURIComponent(s)}`;
}

function renderTickers(signals) {
  const map = {};
  signals.forEach(r => (r.tickers || []).forEach(t => {
    const k = (t.symbol || '').toUpperCase();
    if (!k) return;
    if (!map[k]) map[k] = { s: k, acts: new Set(), n: 0 };
    map[k].acts.add(t.action); map[k].n++;
  }));
  const list = Object.values(map).sort((a, b) => b.n - a.n);
  const el = $('tickerBar');
  if (!list.length) { el.innerHTML = ''; el.className = ''; return; }
  el.className = 'ticker-bar';
  el.innerHTML = list.map(t => {
    // If both buy and sell, show "mixed"
    const hasBuy = t.acts.has('buy');
    const hasSell = t.acts.has('sell');
    const pa = (hasBuy && hasSell) ? 'mixed' : ['sell', 'buy', 'hold', 'watch'].find(a => t.acts.has(a)) || 'watch';
    const url = tickerUrl(t.s);
    return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="ticker-item"><span class="ticker-sym">${esc(t.s)}</span><span class="ticker-act" style="color:${ACT_C[pa]}">${pa}</span>${t.n > 1 ? `<span class="ticker-cnt">Ã—${t.n}</span>` : ''}</a>`;
  }).join('');
}

function renderScanActions() {
  $('scanActions').innerHTML = '';
}

function renderSignals(signals) {
  const el = $('results');
  filters = { category: null }; // reset filters
  if (!signals.length) { el.innerHTML = '<div class="empty-state">No signals extracted</div>'; renderScanActions(); renderFilters(); $('footer').innerHTML = ''; return; }
  
  // Build tweet URL to info map from rawTweets
  const tweetMap = {};
  if (lastScanResult?.rawTweets) {
    lastScanResult.rawTweets.forEach(a => {
      (a.tweets || []).forEach(tw => {
        const url = tw.url || `https://x.com/i/status/${tw.id}`;
        const date = tw.createdAt ? new Date(tw.createdAt) : null;
        const timeStr = date ? date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        tweetMap[url] = {
          text: tw.text || '',
          author: tw.author?.userName || a.account || '',
          time: timeStr
        };
      });
    });
  }
  
  let h = '';
  signals.forEach((item, i) => {
    const cc = CAT_C[item.category] || 'var(--text-muted)';
    const tweetInfo = item.tweet_url ? (tweetMap[item.tweet_url] || {}) : {};
    const source = (item.source || '').replace(/^@/, '');
    const time = tweetInfo.time || '';
    
    const tickers = (item.tickers && item.tickers.length)
      ? item.tickers.map(t => {
          const url = tickerUrl(t.symbol || '');
          return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="ticker-tag" style="color:${ACT_C[t.action] || 'var(--text-muted)'}">${esc(t.symbol)}<span class="a">${t.action}</span></a>`;
        }).join('')
      : '';
    
    const extLinks = (item.links && item.links.length)
      ? item.links.map(l => `<a href="${esc(l)}" target="_blank" rel="noopener noreferrer" class="ext-link">${esc(new URL(l).hostname.replace('www.',''))}</a>`).join(' ')
      : '';
    
    const sourceLink = item.tweet_url 
      ? `<a href="${esc(item.tweet_url)}" target="_blank" rel="noopener noreferrer" data-tweet="${esc(tweetInfo.text || '')}" data-author="${esc(source)}" data-time="${esc(time)}">@${esc(source)}</a>`
      : `@${esc(source)}`;
    
    const seePost = item.tweet_url
      ? `<a href="${esc(item.tweet_url)}" target="_blank" rel="noopener noreferrer" class="see-post" data-tweet="${esc(tweetInfo.text || '')}" data-author="${esc(source)}" data-time="${esc(time)}">See post</a>`
      : '';
    
    h += `<div class="signal" data-category="${esc(item.category || '')}">
      <div class="sig-top"><span>${sourceLink}${time ? ` Â· ${time}` : ''}</span>${seePost}</div>
      ${tickers ? `<div class="sig-tickers">${tickers}</div>` : ''}
      <div class="sig-title">${esc(item.title || '')}</div>
      <div class="sig-summary">${esc(item.summary || '')}</div>
      ${extLinks ? `<div class="sig-links">${extLinks}</div>` : ''}
      <div class="sig-bottom">
        <span class="sig-cat" style="color:${cc}">${esc(item.category || '')}</span>
      </div>
    </div>`;
  });
  el.innerHTML = h;
  renderScanActions();
  renderFilters();
  $('footer').innerHTML = 'Not financial advice';
  setupTweetTooltips();
  el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function setupTweetTooltips() {
  const tooltip = $('tweetTooltip');
  document.querySelectorAll('.see-post[data-tweet]').forEach(link => {
    link.addEventListener('mouseenter', e => {
      const text = link.dataset.tweet;
      if (!text) return;
      const author = link.dataset.author || '';
      const time = link.dataset.time || '';
      const header = (author || time) ? `<div style="opacity:.7;margin-bottom:8px">@${esc(author)} Â· ${esc(time)}</div>` : '';
      tooltip.innerHTML = header + esc(text);
      tooltip.classList.add('vis');
    });
    link.addEventListener('mousemove', e => {
      const x = e.clientX + 12;
      const y = e.clientY + 12;
      // Keep tooltip in viewport
      const rect = tooltip.getBoundingClientRect();
      const maxX = window.innerWidth - rect.width - 20;
      const maxY = window.innerHeight - rect.height - 20;
      tooltip.style.left = Math.min(x, maxX) + 'px';
      tooltip.style.top = Math.min(y, maxY) + 'px';
    });
    link.addEventListener('mouseleave', () => {
      tooltip.classList.remove('vis');
    });
  });
}

function renderDebug() {
  const el = $('debugSection');
  if (!logs.length) { el.innerHTML = ''; return; }
  el.innerHTML = `<div class="debug-section">
    <button class="debug-toggle" id="debugToggle">â–¸ Debug</button>
    <div class="debug-content" id="debugContent">
      ${logs.map(l => `<div class="debug-entry"><span style="color:var(--text-muted)">@${esc(l.a)}</span> â€” ${l.len} ${l.a === '_analysis' ? 'chars' : 'tweets'}<div style="color:var(--text);margin-top:2px">${esc(l.pre)}</div></div>`).join('')}
    </div>
  </div>`;
  $('debugToggle').addEventListener('click', function() {
    const c = $('debugContent');
    const open = c.classList.toggle('open');
    this.textContent = (open ? 'â–¾' : 'â–¸') + ' Debug';
  });
}

// --- Filters ---
function setFilter(type, value) {
  filters[type] = filters[type] === value ? null : value;
  applyFilters();
  renderFilters();
}

function applyFilters() {
  const rows = document.querySelectorAll('#results .signal');
  rows.forEach(row => {
    const cat = row.dataset.category;
    const catMatch = !filters.category || cat === filters.category;
    row.classList.toggle('hidden', !catMatch);
  });
}

function renderFilters() {
  const el = $('filterBar');
  if (!lastScanResult || !lastScanResult.signals.length) { el.innerHTML = ''; return; }
  
  let h = '<div class="filter-bar">';
  CATEGORIES.forEach(c => {
    const on = filters.category === c ? ' on' : '';
    h += `<button class="rng${on}" onclick="setFilter('category','${c}')">${c}</button>`;
  });
  h += '</div>';
  el.innerHTML = h;
}

// --- Init ---
setTheme(getTheme());
setFont(getFont());
setCase(getCase());
loadAccountsData();
loadLoadedPresets();
render();

// Load previous scan on refresh
const savedScan = loadCurrentScan();
if (savedScan) {
  lastScanResult = savedScan;
  const d = new Date(savedScan.date);
  const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  setStatus(`${dateStr} Â· <span class="hide-mobile">${savedScan.accounts.length} accounts Â· ${savedScan.totalTweets} tweets Â· </span>${savedScan.signals.length} signals`, false, true);
  renderTickers(savedScan.signals);
  renderSignals(savedScan.signals);
}
</script>
</body>
</html>